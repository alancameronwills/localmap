<!DOCTYPE HTML>
<!--15.-->
<html>
<head>
    <title>Heritage Map</title>
    <meta name="viewport"
        content="width=device-width, user-scalable=no, minimum-scale=1, maximum-scale=1,initial-scale=1" />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <script>
        window.version = 48;
        //window.maintenance = location.hash=="#nomaint" ? null : "maintenance";
    </script>
    <script src="scripts/azure-storage.common.min.js"></script>
    <script src="scripts/azure-storage.blob.min.js"></script>
    <script src="scripts/heic2any.min.js"></script>
    <script src="scripts/jquery-3.4.1.min.js"></script>
    <script src="scripts/markerclustererplus.min.js"></script>
    <script src="scripts/util.js?v=57"></script>
    <script src="scripts/splash.js?v=11"></script>
    <script src="scripts/sign-in.js?v=29"></script>
    <script src="scripts/exif-js.js"></script>
    <script src="scripts/model.js?v=33"></script>
    <script src="scripts/lightbox.js?v=14"></script>
    <script src="scripts/azuredb.js?v=25"></script>
    <script src="https://nls.tileserver.com/api.js"></script>
    <script src="scripts/maps.js?v=72"></script>
    <script src="scripts/text-edit.js?v=8"></script>
    <script src="scripts/deep-map.js?v=90"></script>
    <script src="scripts/editor.js?v=21"></script>
    <script src="scripts/petals.js?v=12"></script>
    <script src="scripts/pics.js?v=10"></script>
    <script src="scripts/help.js?v=6"></script>
    <script src="scripts/groupSelector.js?v=6"></script>
    <script src="scripts/index.js?v=34"></script>
    <script src="scripts/track.js?v=20"></script>
    <script src="scripts/ProximityPolygons.js?v=5"></script>
    <script src="scripts/zones.js?v=6"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="scripts/recorder.js"></script>
    <script src="scripts/recordingUI.js?v=3"></script>

    <link rel="icon" type="img/png" href="img/favicon96.png" sizes="96x96" />
    <link rel="icon" type="img/png" href="img/favicon32.png" sizes="32x32" />
    <link rel="icon" type="img/png" href="img/favicon16.png" sizes="16x16" />
    <link rel="stylesheet" type="text/css" href="css/deep-map.css?v=51" />
    <link rel="stylesheet" href="scripts/v6.5.0-dist/ol.css" />
    <style>
        #splash {
            position: absolute;
            top: 0px; 
            bottom: 0px;
            left: 0px;
            right: 0px;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 200;
            transition: all 1s;
        }

        #splashPanel {
            border-radius: 10px;
            border: black solid 4px;
            background-color: white;
            font: sans-serif 18pt;
            color: darkblue;
            position: absolute;
            top: 5%;
            left: 10%;
            right: 10%;
            bottom: 5%;
            display: block;
            transition: all 1s;
        }

        .splashScroller {
            position: absolute;
            top: 0px;
            bottom: 0px;
            overflow: auto;
            padding: 10px;
            transition: all 1s;
        }

        /* Avoid logos forcing column wide: */
        #splashPanel img {
            max-width: 70vw;
            max-height: 50vh;
        }

        @media (min-width:800px) {
            .splashLogoAlignLeft {
                float: left;
                vertical-align: top;
            }
        }
        .splash-columns {
            width:100%;
            display:flex;
            flex-direction: row;
            justify-content: space-between;
            gap:6px;
        }
        .splash-columns button {
            background-color: aliceblue;
            padding: 4px 6px;
        }
        button {
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            outline: 1px solid skyblue;
        }
    </style>
    <script>
        // Occasional problem loading map
        if (!window.maintenance) {
            window.restartTimer = setTimeout(() => { window.location.reload(); }, 20000);
        }
    </script>
</head>

<body onload="init()">
    <div>
        <div id='theMap' ondragover="dragOverMap(event)">
            <h2 style="color:grey;font-family: 'Times New Roman', Times, serif">&nbsp;
                <br />
                <br /><span id="loadingMapStatus">Loading the map...</span>
            </h2>
        </div>
    </div>
    <div id="topLayer">
        <div id="loosePicsShow"></div>
        <div id='topLeftControls' class="buttonPanel">
            <div id="usernamediv" class="panelButton whiteButton">
                <span id="usernamespan"></span>
                <input id="signInButtonTop" type='button' onclick='signin()' value='Sign in'
                    title="Sign in to add places and comments" /> 
                <img id="settingsButton" src="img/settings.png"
                    style="display:none;width:25px;height:25px;vertical-align: middle;" title="Settings"
                    onclick="onSettingsButton()" />
            </div>
            <div id='pauseButton' class="panelButton whiteButton" style="display:none" onclick="window.tracker.onPauseButton()"
                title="Pause/resume tracking">
                <img src='img/tracking.png'/></div>
            <div id='showHelpButton' class="panelButton whiteButton" onclick="dohelp()" title="help/about">?</div>
            <!--<div id="locationPopup" class="panelButton whiteButton" onclick="selectLocation()">
                <img src="img/map-pin.png" height="90%"/>
            </div>
            
            <div id="locationPopupID" class="popup">
                <div class="popup-content">
                    <span class="close">&times;</span>
                    <p>Select a project to view!</p>
                    <p><button class="selection" onclick="window.map.projectName = 'garnFawr', map.setArea()">Garn Fawr</button>
                    <button class="selection" onclick="window.map.projectName = 'folio', map.setArea()">FOLIO Sutton Coldfield</button>
                    <button class="selection" onclick="window.map.projectName = 'trewyddel', map.setArea()">Trewyddel</button>
                    <button class="selection" onclick="window.map.projectName = 'trefdraeth', map.setArea()">Trefdraeth</button>
                    <p><button class="cancel">Cancel</button>
            </div>
            
            </div>-->


            <!-- Button for adding pics or other files to a place -->
            <div id="addFileButton" class="panelButton addButton" title="Upload pics and then place them on the map"
                onclick="showFileSelectDialog('uploadButton')" style="display:none">++</div>
            <input id="uploadButton" style="display:none;opacity: 0;" onchange="doUploadFiles(this, this.files, null)"
                type="file" title="upload" name="uploadButton" multiple />
            <div id="addPlaceButton" class="panelButton addButton"
                title="Put notes and pictures on the map at the target point" onclick="onAddPlaceButton(this)"
                style="display:none">+</div>
            <div id="addVideoButton" class="panelButton addButton"
                title="Put a video on the map at the target point" onclick="onAddVideoButton(this)"
                style="display:none"><img src="img/add-video.png" /></div>
            <div id="workingTitle" class="panelButton whiteButton"></div>
            <div id="picLaundryFlag" class="panelButton"
                title="Picture or place upload in progress, or waiting for connection">^</div>
            <br>

        </div>
        <div id='topMessage' class='noselect' style="visibility: hidden"></div>
        <div id="target" class="target" style="pointer-events:none"
            title="Position a place under here then click the button on the right to add notes">
            <div class="noselect" style="position:relative;top:10px">^</div>
        </div>

        <a href="#" target="_blank" id="fullWindowButton" style="display:none" onclick="frameBreakout()"><img
                class="panelButton" title="full window" src="img/expand.png" /></a>
        <div class="dropdown" id="cartographyDropdown">
            <div id="cartographyButton" onclick="selectCartography()"
                class="whiteButton panelButton">Cartography&#8681;</div>
            <div id="mapDropdown" class="dropdown-content">
                <a id="dropdownSelection1" onclick="selectedMap = 'google', mapSelect()">Google</a>
                <a id="dropdownSelection2" onclick="selectedMap = 'bing', mapSelect()">Bing</a>
                <a id="dropdownSelection3" onclick="selectedMap = 'osm', mapSelect()">OpenStreetMap</a>
            </div>
        </div>
        <div class="panelButton whiteButton" id="opacitySlider" onclick="opacitySlider()">Labels</div>



        <img id="mapbutton" class="panelButton" onclick="map.toggleType(event)" oncontextmenu="map.toggleOpacity()" title="Aerial/map. CTRL for transparent overlay" src="img/map-icon.png" />
        <input id="addressSearchBox" class="geoSearch searchInput panelButton whiteButton" type="textbox"
            placeholder="Postcode or place" onchange="window.map.codeAddress(this.value)">
        <!-- input id="geoSearchButton" type="button" value="Search" onclick="window.map.codeAddress()" -->
        <div id="infowindow-content">
            <span id="place-name" class="title"></span><br />
            <strong>Place ID</strong>: <span id="place-id"></span><br />
            <spanid="place-address"></span>
        </div>

        <!--<img id="swenable" class="panelButton" onclick="RegisterSW()" title="Enable SW" src="img/tick.png"/>-->
        <!--<img id="swdisable" class="panelButton" onclick="UnregisterSW()" title="Disable SW" src="img/redX.png"/>

        <button id="offlinePopup" class="panelButton" onclick="offline()">?</button>
        <div id="offlinePopupID" class="popup">
          <div class="popup-content">
            <span class="close">&times;</span>
            <p>This map has the ability to function offline in any location that you specify<br>If you are planning on using this map offline, please select "Ok!" and then right click the area of the map that you wish to see when offline and select "Offline area"</p>
            <p><button class="ok" onclick="RegisterSW()">Ok!</button>
                <button class="cancel">Cancel</button>
          </div>
        </div>-->

        <!--<div id="loadingPopupID" class="popup">
            <div class="popup-content">
              <p>Please wait while the selected area of the map is loaded and stored on your device...</p>
              <p><div id="myProgress">
                <div id="myBar">0%</div>
              </div></p>
              </div>
        </div>-->


        <div id="groupSelectorBox"></div>
        <div id="indexSidebar"></div>
        <div id="indexFlag" style="display:none">
            <div onclick="index.openIndex()">&gt;</div>
        </div>
        <div id="bottomLeftPanel">
            <div style="display: inline-block;position:relative;">
                <input id="searchButton" type="text" class="searchInput panelButton smallButton"
                    placeholder="Search index" onchange="index.doSearch(this.value.trim())" title="search" />
                <span id="searchCount"
                    style="position: absolute;left:4px;top:2px;color:darkred;font-size:small;"></span>
                <span id="searchCancel" style="position:absolute;right:15px;top:3px;color:red;display:none;"
                    onclick="g('searchButton').value='';index.doSearch('')">X</span>
            </div>
            <div id="tagKeyButton" class="panelButton smallButton" onclick="showTagsKey()" title="Filter by tag">Tags
            </div>
            <div id="recentButton" class="panelButton smallButton" onclick="index.doRecent()"
                title="Recent changes and additions">New!</div>
            <div id="toggleLanguageButton" class="panelButton smallButton languageToggle" onclick='toggleLanguage()'>Cymraeg</div>
        </div>
        <div id="NLScredit">Historical maps: <a href="https://maps.nls.uk/" target="_blank">National Library of Scotland</a></div>
        <div id="tagsKey" onclick="hideTagsKey()">
            <div id="tagsKeyPanel">
                <div id="id2">
                    <div class="tagKeyButton"></div> Rocks
                </div>
            </div>
        </div>
        <div id="basehelp" class="helpBox" style="display:none">
            <div class="closeX boxClose" onclick="closeBaseHelp()">X</div>
            <p style="margin-top:0"><b id="helpRefAddHead">Add places to the map</b></p>
            <p id="helpRefDragMap">Drag the map so that the target <span id="helpRefTarget"><b>^</b></span> points to a
                place you have something to show or tell about.</p>
            <p id="helpRefTracking">If you're mobile, click <b id="helpRefGT">&gt;</b> to track your position.</p>
            <p id="helpRefAdd">Click <b id="helpRefPlus">+</b> to create a place at the target. You'll then be able to
                type notes or add photos or sound files.</p>
            <p id="helpRefAddPics">If you have photos of several places, click <b id="helpRefPlusPlus">++</b> to put
                them on the map in one go.
            </p>
            <p id="helpRefAddVideo">Click <b id="helpRefPlusVideo">[>+]</b> to add a video to the map.</p>
            <button id="closeBaseHelpButton" onclick="closeBaseHelp()">Close</button>
            <button id="baseHelpUserGuideButton" onclick="openUserGuide()">User guide</button>
            <svg id="svgBaseHelp"></svg>
        </div>
        <div id="popup" class="floatingPopup">
            <div id="popuptextgroup">
                <div></div>
                <div id="groupEditorBox"></div>
                <div id="toolBar1">
                    <div class="toolbutton" onclick="onFormatDoc('formatblock','h4')" id="toolHead" title="Sub heading">
                        H
                    </div>
                    <div class="toolbutton" onclick="onFormatDoc('formatblock','div')" id="toolPara"
                        title="Plain paragraph">¶</div>
                    <div id="welshKeys" style="display:inline-block">
                        <div class="toolbutton" onclick="onInsertText('â')">â</div>
                        <div class="toolbutton" onclick="onInsertText('ê')">ê</div>
                        <div class="toolbutton" onclick="onInsertText('î')">î</div>
                        <div class="toolbutton" onclick="onInsertText('ô')">ô</div>
                        <div class="toolbutton" onclick="onInsertText('û')">û</div>
                        <div class="toolbutton" onclick="onInsertText('ŵ')">ŵ</div>
                        <div class="toolbutton" onclick="onInsertText('ŷ')">ŷ</div>
                    </div>
                    <div class="toolbutton" onclick="onCreateLink()" id="insertLinkButton" title="Insert link"><img
                            src="img/link.png" width="18px" height="18px"></div>
                    <div id="popupTimestampTextBox" class="toolbutton"
                        style="position:absolute;right:0px;background-color:rgba(0,0,0,0);color:black"></div>
                </div>
                <div class="popupTextBox">
                    <div id="editorTitleDescriptionPrompt" class="popupTextTopLine">TITLE<br /><br />DESCRIPTION
                    </div>
                    <div class="popupcontent">
                        <div id="popuptext" contenteditable="true" onclick="event.stopPropagation()">
                        </div>
                        <div id="popupComments"></div>
                    </div>
                </div>
                <div id="picturebar" class="picturebar">
                    <div id="thumbnails"></div>
                    <!-- The add button displays the ugly traditional "input file" and clicks it -->
                    <div class="panelButton addButton " id="addPicToPlaceButton"
                        onclick="showFileSelectDialog('uploadToPlaceButton')"
                        title="Add photos or sound files to this note"
                        ><img src="img/add-pic.png" height="25px" style="padding:3px"/></div>
                    <!-- But we set opacity:0 so the ugly input isn't visible, even when 'displayed' -->
                    <input id="uploadToPlaceButton" style="display:none;opacity: 0; width:2px;"
                        onchange="doUploadFiles(this, this.files, g('popup').placePoint)" type="file" title="upload"
                        name="uploadToPlaceButton" multiple />
                    <div class="panelButton addButton " id="addVideoToPlaceButton"
                            onclick="onAddVideoToPlaceButton(g('popup').placePoint)"
                            title="Add video to this note"
                            ><img src="img/add-video.png" height="25px" style="padding:3px"/></div>
                    <div id="voiceRecorder" class="panelButton addButton " onclick="showVoiceRecorder()"
                        title="Voice recorder"><img src="img/recorder.png" height="25px" style="padding: 3px;" /></div>
                    <div id="getLinkButton" class="panelButton addButton "
                        onclick="showLink(g('popup').placePoint.place, event)" title="Share a link to this place">
                        <img src="img/getlink.png" />
                    </div>
                    <div id="editorHelpButton" class="panelButton addButton " onclick="showEditorHelp()" title="Help">?
                    </div>
                </div>
            </div>
            <div id="tags"> </div>
            <div id="author"> </div>
            <div id="popclose" onclick="closePopup()">X</div>

            <div id="recorderPopup">
            </div>

            <div id="editorHelp">
                <div id="editorHelpContent">
                    <p id="eh1">Type a title and notes related to this place.You need at least the first line, which is
                        the
                        title. </p>
                    <p id="eh2">Select one or more coloured tags to show roughly what this is about.</p>
                    <p id="eh3">Add pictures, sound files, or other files. The pictures will play in sequence like a
                        slide show. Drag a thumbnail to change the sequence. Right-click/long-touch a picture to give it
                        a title.
                        To have a sound file play while the slides change, upload the file here.</p>
                    <p id="eh4">To synchronise sounds and pictures, use a sound app to snip the sound file into separate
                        parts for each picture.
                        Right-click/long-touch each picture to attach its sound file.</p>
                    <p id="eh5">To attach a YouTube video, first get a share link like https://youtu.be/...
                        Then back here, click Add Video and paste the link.
                    </p>
                    <button id="closeEditorHelpButton" onclick="closeEditorHelp()">Close</button>
                    <button id="editorHelpUserGuideButton" onclick="openUserGuide()">User guide</button>
                </div>
                <div id="editorHelpCloser" class="closeX boxClose" onclick="closeEditorHelp()">X</div>
                <svg id="editorHelpSvg"></svg>
            </div>
        </div>

        <!-- autoplay => Track will play automatically if user has clicked at least once in the page. -->
        <div id="audiodiv" class="avbox"></div>

        <div id="petals">
        </div>

        <div id="lightbox"> </div>

        <div id="loosePicMenu" class="menu" onmouseleave="hide(this)">
            <div>&nbsp;</div>
            <div onclick="onmenuclick(this, placeLoosePicCmd)" id="placeLoosePicMenu">Place at focus mark</div>
        </div>

        <div id="openAuthorMenu" class="menu" onmouseleave="hide(this)">
            <div>&nbsp;</div>
            <div onclick="onmenuclick(this, openAuthorCmd)" id="openAuthorMenuItem">Open authorship</div>
            <div onclick="onmenuclick(this, editAuthorCmd)" id="editAuthorMenuItem">Change author name</div>
            <div onclick="onmenuclick(this, editRangeCmd)" id="editTrackingRangeItem">Change tracking range</div>
        </div>

        <div id="petalMenu" class="menu" onmouseleave="hide(this)">
            <div>&nbsp;</div>
            <div onclick="onmenuclick(this, titlePicCmd)" id="retitlePicMenu">Re-title pic/file</div>
            <div onclick="onmenuclick(this, deletePicCmd)" id="deletePicMenu">Delete pic/file</div>
            <div onclick="onmenuclick(this, attachSoundCmd)" id="attachSoundMenu">Attach a sound file</div>
            <div onclick="onmenuclick(this, attachYouTube)" id="attachYouTubeMenu">Attach a YouTube video</div>
            <div onclick="onmenuclick(this, rotatePicCmd)" id="rot90Menu">Rotate 90deg</div>
            <!-- <div onclick="onmenuclick(this, movePicCmd)" id="movePicMenu">Move pic/file to another place</div> -->
        </div>
        <div id="fileMenu" class="menu" onmouseleave="hide(this)">
            <div>&nbsp;</div>
            <div onclick="onmenuclick(this, deletePicCmd)" id="deletePicMenu">Delete</div>
            <div onclick="onmenuclick(this, titlePicCmd)" id="retitlePicMenu">Re-title pic/file</div>
            <div onclick="onmenuclick(this, downloadFileCmd)" id="downloadFileMenu">Download</div>
        </div>

        <div id="petalTextMenu" class="menu" onmouseleave="hide(this)">
            <div>&nbsp;</div>
            <div onclick="onmenuclick(this, movePlaceCmd)" id="movePlaceMenu">Move place to target</div>
            <div onclick="onmenuclick(this, deletePlaceCmd)" id="deletePlaceMenu">Delete place</div>
            <div onclick="onmenuclick(this, startTrailCmd)" id="startTrailMenu">Start trail</div>
            <div onclick="onmenuclick(this, continueTrailCmd)" id="continueTrailMenu">Continue trail</div>
        </div>

        <div id="titleDialog" onclick="hide(this)"
            style="display:none;position:absolute;top:0px;left:0px;bottom:0px;right:0px;background-color:rgba(0,0,0,0.5)">
            <div
                style="border-radius:10px;position:relative;top:30%;max-width:80%; width:500px; margin: 0 auto;background-color:whitesmoke;border: 2 solid blue; padding:10px;">
                <p id="editTitlePrompt">Edit the title</p>
                <div id="titleInput" type="text"
                    style="width:90%;height:50px;margin:auto;overflow:hidden;background-color: white;color:black;border:1px solid blue;padding:4px;"
                    contenteditable="true" onblur="this.whenDone(this.innerText)"
                     ></div>
                <button>Done</button>
            </div>
        </div>
            <div id="rangeDialog" onclick="hide(this)"
                style="display:none;position:absolute;top:0px;left:0px;bottom:0px;right:0px;background-color:rgba(0,0,0,0.5)">
                <div
                    style="border-radius:10px;position:relative;top:30%;max-width:80%; width:500px; margin: 0 auto;background-color:whitesmoke;border: 2 solid blue; padding:10px;">
                    <p id="editRangePrompt">Edit the tracking range</p>
                    <div id="rangeInput" type="text"
                        style="width:90%;height:50px;margin:auto;overflow:hidden;background-color: white;color:black;border:1px solid blue;padding:4px;"
                        contenteditable="true" onblur="this.whenDone(this.innerText)"></div>
                </div>
            </div>
        <!-- Input dialog for adding a sound file to a pic -->
        <input id="attachSoundInput" style="display:none;opacity: 0;" onchange="doAttachSound(this)" type="file"
            title="sound file" name="attachSoundInput" />

        <!-- Creating a link in the editor -->
        <div id="linkDialog" class="dialog" onClick="hide(this)">
            <div onclick="noPropagate(event)">Paste a link to a web page here:
                <br />
                <input id="linkRef" type="text" size="20" pattern="https?://.+|\.\/\?place=[0-9]{3}"
                    placeholder="http://..." />
                <input type="button" onclick="CompleteCreateLink()" value="Link" />
                <span id="linkRemoveOption">
                    - or -
                    <br />
                    <input type="button" onclick="CompleteRemoveLink()" value="Remove link" />
                </span>
            </div>
        </div>


        <!--div style="position:fixed; top:0px; left: 0px;padding:4px;background-color:yellow" id="msg"></div -->
        <div id="splash">
            <div id="splashPanel">
                <div class="splashScroller" id="splashScreen">

                </div>
                <div class="closeX boxClose splashCloser" onclick="splashScreen.dropSplash()" style="display:none" id="splashCloseX">
                    X</div>
            </div>
        </div>
        <div id="menu" class="menu"></div>
        <div id="message" class="dialog" onclick="hide(this)">
            <div id="messageInner"></div>
        </div>

        <div id="youtube" onclick="hide(this);g('youtubePlayer').src=''">
            <iframe id="youtubePlayer" type="text/html">
            </iframe>
        </div>
        <div id="configDialog" class="dialog" onclick="hide(this)">
            <div onclick="event.cancelBubble=true">
                <div id="configHeader"></div>
                <p>
                    <button id="signOutButton2" onclick='hide("configDialog");signOut()' title='Sign out'>Sign
                        out</button>
                </p>
                <div id="config"></div>
                <div id="projectLink" style="display:none">
                    <hr />
                    <a href="contributors.html" target="settings"><button>Project settings &gt;</button></a>
                    <a id="statsLink" href="stats.html" target="settings"><button>Stats &gt;</button></a>
                    <a id="exportLink" target="settings"><button>Print all &gt;</button></a>
                    <a id="rawExportLink" target="settings"><button>Export</button></a>
                    <button onclick="hide('configDialog');showZoneUI();">Groupie</button>
                </div>
            </div>
        </div>
    </div>
    <div id="zones" style="position:fixed;top:0;left:0;width:100vw;height:100vh;display:none;"></div>
    <div id="curtain"
        style="z-index:400;position:fixed;top:0;left:0;width:100vw;height:100vh;background-color: whitesmoke;transition: all 1s;">
        ...</div>
    <iframe style="z-index: 2000;height:750px;width:600px;position: absolute; left:50px; top:50px;display:none;"
        id="signinFrame"></iframe>
    <script>
        setCookie("assurance", "2");
        try { if (localStorage) localStorage.clear(); } catch { }


        /*
        if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
                console.log("mobile device");
                window.location.href = 'mobileIndex.html';
        } else {
                console.log("not mobile device");
        }
        */
    </script>



</body>

</html>
